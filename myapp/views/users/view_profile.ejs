<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau de Bord</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
<%- include("../navbar.ejs") %>
<div class="container my-5">
    <%- include("../message.ejs") %>
    <div class="row">
        <div class="col-md-10 offset-md-1">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0">Profil de <%= user.Prenom %> <%= user.Nom %></h2>
                <% if (currentUserEmail === user.Email) { %>
                    <a href="/logout" class="btn btn-danger">Se déconnecter</a>
                <% } %>
            </div>
            <div class="card">
                <div class="card-header bg-primary text-white">
                    Détails du Profil
                </div>
                <div class="card-body">
                    <p class="card-text">
                        <strong>Email :</strong> <%= user.Email %>
                        <% if (currentUserEmail === user.Email || userRole === 'administrateur') { %>
                            <button class="btn btn-link" data-bs-toggle="modal" data-bs-target="#editEmailModal">
                                <i class="fas fa-edit"></i>
                            </button>
                        <% } %>
                    </p>
                    <p class="card-text">
                        <strong>Téléphone :</strong> <%= user.Telephone %>
                        <% if (currentUserEmail === user.Email || userRole === 'administrateur') { %>
                            <button class="btn btn-link" data-bs-toggle="modal" data-bs-target="#editTelephoneModal">
                                <i class="fas fa-edit"></i>
                            </button>
                        <% } %>
                    </p>
                    <p class="card-text">
                        <strong>Date de création
                            :</strong> <%= new Date(user.DateCreation).toLocaleDateString("fr-FR") %>
                    </p>
                    <p class="card-text">
                        <strong>Statut du Compte :</strong> <%= user.StatutCompte %>
                    </p>
                    <p class="card-text">
                        <strong>Type de Compte :</strong> <%= user.TypeCompte %>
                        <% if (user.TypeCompte && user.TypeCompte.toLowerCase() === 'candidat' && (currentUserEmail === user.Email || userRole === 'administrateur')) { %>
                            <button class="btn btn-warning" data-bs-toggle="modal"
                                    data-bs-target="#requestRecruiterModal">Demander à devenir recruteur
                            </button>
                        <% } else if (user.TypeCompte && user.TypeCompte.toLowerCase() === 'recruteur en attente' && (currentUserEmail === user.Email || userRole === 'administrateur')) { %>
                    <form method="post" action="/organizations/cancel-recruiter-request">
                        <input type="hidden" name="userId" value="<%= user.Email %>">
                        <button type="submit" class="btn btn-secondary">Annuler la demande</button>
                    </form>
                    <% } %>
                    </p>
                    <% if (user.TypeCompte && user.TypeCompte.toLowerCase() === 'recruteur') { %>
                        <p class="card-text">
                            <strong>Organisation :</strong> <%= user.IdOrganisation %>
                            <% if (currentUserEmail === user.Email || userRole === 'administrateur') { %>
                                <button class="btn btn-link" data-bs-toggle="modal"
                                        data-bs-target="#editOrganisationModal">
                                    <i class="fas fa-edit"></i>
                                </button>
                            <% } %>
                        </p>
                    <% } %>
                    <% if (currentUserEmail === user.Email) { %>
                        <!-- Seul l'utilisateur connecté peut modifier son mot de passe -->
                        <p class="card-text">
                            <button class="btn btn-link" data-bs-toggle="modal" data-bs-target="#editPasswordModal">
                                <i class="fas fa-key"></i> Modifier le mot de passe
                            </button>
                        </p>
                    <% } else if (userRole === 'administrateur') { %>
                        <!-- Seul l'administrateur peut réinitialiser le mot de passe -->
                        <p class="card-text">
                        <form action="/users/reset-password" method="post">
                            <input type="hidden" name="userId" value="<%= user.Email %>">
                            <button class="btn btn-warning" type="submit">Réinitialiser le mot de passe</button>
                        </form>
                        </p>
                    <% } %>
                </div>
            </div>
        </div>
    </div>
</div>

<%- include("../modal.ejs", { modalId: "editOrganisationModal", modalLabelId: "editOrganisationModalLabel", modalTitle: "Modifier l'Organisation", modalBody: "forms/edit_organisation_form.ejs", organisations: organisations, user: user }) %>
<%- include("../modal.ejs", { modalId: "requestRecruiterModal", modalLabelId: "requestRecruiterModalLabel", modalTitle: "Demande à devenir recruteur", modalBody: "forms/recruiter_request_form.ejs", user: user }) %>
<%- include("../modal.ejs", { modalId: "editEmailModal", modalLabelId: "editEmailModalLabel", modalTitle: "Modifier l'Email", modalBody: "forms/edit_email_form.ejs", userId: user.Email }) %>
<%- include("../modal.ejs", { modalId: "editTelephoneModal", modalLabelId: "editTelephoneModalLabel", modalTitle: "Modifier le Téléphone", modalBody: "forms/edit_telephone_form.ejs", userId: user.Email }) %>
<%- include("../modal.ejs", { modalId: "editPasswordModal", modalLabelId: "editPasswordModalLabel", modalTitle: "Modifier le Mot de Passe", modalBody: "forms/edit_password_form.ejs" }) %>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.querySelectorAll('.modal').forEach(modal => {
        const selectElement = modal.querySelector('select');
        if (selectElement) {
            selectElement.addEventListener('change', function () {
                const newOrganisationFields = modal.querySelector('#newOrganisationFieldsEdit') || modal.querySelector('#newOrganisationFields');
                if (this.value === 'new') {
                    newOrganisationFields.classList.remove('d-none');
                    newOrganisationFields.querySelectorAll('input').forEach(input => input.required = true);
                } else {
                    newOrganisationFields.classList.add('d-none');
                    newOrganisationFields.querySelectorAll('input').forEach(input => input.required = false);
                }
            });
        }

        const formElement = modal.querySelector('form');
        if (formElement) {
            formElement.addEventListener('submit', function (event) {
                if (selectElement && (!selectElement.value || selectElement.value === '')) {
                    event.preventDefault();
                    alert('Veuillez sélectionner une organisation.');
                }
            });
        }
    });
</script>
</body>
</html>
