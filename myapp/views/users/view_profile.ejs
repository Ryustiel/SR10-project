<!DOCTYPE html>
<html lang="fr">
<head>
    <%- include('../head.ejs') %>
    <title>Profil de <%= user.Prenom %> <%= user.Nom %></title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body class="bg-gray-100 font-sans leading-normal tracking-normal">
<%- include("../navbar.ejs") %>
<div class="container mx-auto my-8 p-4">
    <%- include("../message.ejs") %>
    <div class="flex justify-center">
        <div class="w-full md:w-2/3 lg:w-1/2">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-4xl font-semibold text-gray-900 tracking-tight leading-snug font-poppins">Profil de <%= user.Prenom %> <%= user.Nom %></h2>
                <% if (currentUserEmail === user.Email) { %>
                    <a href="/logout" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-full transition duration-300 ease-in-out shadow-md">
                        Se déconnecter
                    </a>
                <% } %>
            </div>
            <div class="bg-white shadow-xl rounded-lg overflow-hidden">
                <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-6">
                    <h3 class="text-2xl font-semibold tracking-tight">Détails du Profil</h3>
                </div>
                <div class="p-6 space-y-4">
                    <div class="flex items-center justify-between">
                        <label class="block text-gray-700 font-semibold flex items-center space-x-2 w-1/3">
                            <i class="fas fa-envelope"></i>
                            <span>Email :</span>
                        </label>
                        <div class="w-2/3 flex items-center justify-between">
                            <span class="text-lg text-gray-900 font-medium"><%= user.Email %></span>
                            <% if (currentUserEmail === user.Email || userRole === 'administrateur') { %>
                                <button class="ml-4 bg-blue-500 text-white hover:bg-blue-600 font-semibold py-1 px-3 rounded-lg shadow-md" data-bs-toggle="modal" data-bs-target="#editEmailModal">
                                    <i class="fas fa-edit"></i>
                                </button>
                            <% } %>
                        </div>
                    </div>
                    <div class="flex items-center justify-between">
                        <label class="block text-gray-700 font-semibold flex items-center space-x-2 w-1/3">
                            <i class="fas fa-phone"></i>
                            <span>Téléphone :</span>
                        </label>
                        <div class="w-2/3 flex items-center justify-between">
                            <span class="text-lg text-gray-900 font-medium"><%= user.Telephone %></span>
                            <% if (currentUserEmail === user.Email || userRole === 'administrateur') { %>
                                <button class="ml-4 bg-blue-500 text-white hover:bg-blue-600 font-semibold py-1 px-3 rounded-lg shadow-md" data-bs-toggle="modal" data-bs-target="#editTelephoneModal">
                                    <i class="fas fa-edit"></i>
                                </button>
                            <% } %>
                        </div>
                    </div>
                    <div class="flex items-center justify-between">
                        <label class="block text-gray-700 font-semibold flex items-center space-x-2 w-1/3">
                            <i class="fas fa-calendar-alt"></i>
                            <span>Date de création :</span>
                        </label>
                        <div class="w-2/3">
                            <span class="text-lg text-gray-900 font-medium"><%= new Date(user.DateCreation).toLocaleDateString("fr-FR") %></span>
                        </div>
                    </div>
                    <div class="flex items-center justify-between">
                        <label class="block text-gray-700 font-semibold flex items-center space-x-2 w-1/3">
                            <i class="fas fa-user-check"></i>
                            <span>Statut du Compte :</span>
                        </label>
                        <div class="w-2/3">
                            <span class="text-lg text-gray-900 font-medium"><%= user.StatutCompte %></span>
                        </div>
                    </div>
                    <div class="flex items-center justify-between">
                        <label class="block text-gray-700 font-semibold flex items-center space-x-2 w-1/3">
                            <i class="fas fa-user-tag"></i>
                            <span>Type de Compte :</span>
                        </label>
                        <div class="w-2/3 flex items-center justify-between">
                            <span class="text-lg text-gray-900 font-medium"><%= user.TypeCompte %></span>
                            <% if (user.TypeCompte && user.TypeCompte.toLowerCase() === 'candidat' && (currentUserEmail === user.Email || userRole === 'administrateur')) { %>
                                <button class="ml-4 bg-yellow-500 text-white hover:bg-yellow-600 font-semibold py-1 px-3 rounded-lg shadow-md" data-bs-toggle="modal" data-bs-target="#requestRecruiterModal">Devenir recruteur</button>
                            <% } else if (user.TypeCompte && user.TypeCompte.toLowerCase() === 'recruteur en attente' && (currentUserEmail === user.Email || userRole === 'administrateur')) { %>
                                <form method="post" action="/organizations/cancel-recruiter-request" class="inline ml-4">
                                    <input type="hidden" name="userId" value="<%= user.Email %>">
                                    <button type="submit" class="bg-gray-500 text-white hover:bg-gray-600 font-semibold py-1 px-3 rounded-lg shadow-md">Annuler</button>
                                </form>
                            <% } %>
                        </div>
                    </div>
                    <% if (user.TypeCompte && user.TypeCompte.toLowerCase() === 'recruteur') { %>
                        <div class="flex items-center justify-between">
                            <label class="block text-gray-700 font-semibold flex items-center space-x-2 w-1/3">
                                <i class="fas fa-building"></i>
                                <span>Organisation :</span>
                            </label>
                            <%
                                const org = organisations.find(org => org.NumeroSiren === user.IdOrganisation);
                            %>
                            <div class="w-2/3 flex items-center justify-between">
                                <span class="text-lg text-gray-900 font-medium">
                                    <%= org ? `${org.Nom} (${org.NumeroSiren})` : user.IdOrganisation %>
                                </span>
                                <% if (currentUserEmail === user.Email || userRole === 'administrateur') { %>
                                    <button class="ml-4 bg-blue-500 text-white hover:bg-blue-600 font-semibold py-1 px-3 rounded-lg shadow-md" data-bs-toggle="modal" data-bs-target="#editOrganisationModal">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                <% } %>
                            </div>
                        </div>
                    <% } %>
                    <% if (currentUserEmail === user.Email) { %>
                        <div class="flex justify-center mt-6">
                            <button class="bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 text-white font-bold py-2 px-6 rounded-full transition duration-300 ease-in-out shadow-lg" data-bs-toggle="modal" data-bs-target="#editPasswordModal">
                                <i class="fas fa-key"></i> Modifier le mot de passe
                            </button>
                        </div>
                    <% } else if (userRole === 'administrateur') { %>
                        <div class="flex justify-center mt-6">
                            <form action="/users/reset-password" method="post">
                                <input type="hidden" name="userId" value="<%= user.Email %>">
                                <button class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-full transition duration-300 ease-in-out shadow-lg flex items-center">
                                    <i class="fas fa-sync-alt mr-2"></i> Réinitialiser le mot de passe
                                </button>
                            </form>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>
    </div>
</div>

<%- include("../modal.ejs", { modalId: "editOrganisationModal", modalLabelId: "editOrganisationModalLabel", modalTitle: "Modifier l'Organisation", modalBody: "forms/edit_organisation_form.ejs", organisations: organisations, user: user }) %>
<%- include("../modal.ejs", { modalId: "requestRecruiterModal", modalLabelId: "requestRecruiterModalLabel", modalTitle: "Demande à devenir recruteur", modalBody: "forms/recruiter_request_form.ejs", user: user }) %>
<%- include("../modal.ejs", { modalId: "editEmailModal", modalLabelId: "editEmailModalLabel", modalTitle: "Modifier l'Email", modalBody: "forms/edit_email_form.ejs", userId: user.Email }) %>
<%- include("../modal.ejs", { modalId: "editTelephoneModal", modalLabelId: "editTelephoneModalLabel", modalTitle: "Modifier le Téléphone", modalBody: "forms/edit_telephone_form.ejs", userId: user.Email }) %>
<%- include("../modal.ejs", { modalId: "editPasswordModal", modalLabelId: "editPasswordModalLabel", modalTitle: "Modifier le Mot de Passe", modalBody: "forms/edit_password_form.ejs" }) %>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.querySelectorAll('.modal').forEach(modal => {
        const selectElement = modal.querySelector('select');
        if (selectElement) {
            selectElement.addEventListener('change', function () {
                const newOrganisationFields = modal.querySelector('#newOrganisationFieldsEdit') || modal.querySelector('#newOrganisationFields');
                if (this.value === 'new') {
                    newOrganisationFields.classList.remove('d-none');
                    newOrganisationFields.querySelectorAll('input').forEach(input => input.required = true);
                } else {
                    newOrganisationFields.classList.add('d-none');
                    newOrganisationFields.querySelectorAll('input').forEach(input => input.required = false);
                }
            });
        }

        const formElement = modal.querySelector('form');
        if (formElement) {
            formElement.addEventListener('submit', function (event) {
                if (selectElement && (!selectElement.value || selectElement.value === '')) {
                    event.preventDefault();
                    alert('Veuillez sélectionner une organisation.');
                }
            });
        }
    });
</script>
</body>
</html>
